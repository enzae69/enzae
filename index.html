<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>enzae chat</title>
<style>
body{margin:0;font-family:Arial;background:#2b2d31;color:#fff}
#top{padding:10px;background:#1e1f22;display:flex;justify-content:space-between}
#app{display:flex;height:calc(100vh - 40px)}
#left{width:250px;background:#1e1f22;padding:10px}
#main{flex:1;padding:10px}
input,button{width:100%;padding:8px;margin:5px 0;border:none;border-radius:4px}
button{background:#5865F2;color:white;cursor:pointer}
.user{padding:5px;border-bottom:1px solid #333}
.online{color:#3ba55d}
.offline{color:#777}
</style>
</head>
<body>

<div id="top">
  <div>enzae</div>
  <button onclick="login()">Login mit Google</button>
</div>

<div id="app" style="display:none">
  <div id="left">
    <h3>üë§ Profil</h3>
    <div id="me"></div>

    <h3>‚ûï Freund adden</h3>
    <input id="addName" placeholder="Username">
    <button onclick="addFriend()">Hinzuf√ºgen</button>

    <h3>üë• Freunde</h3>
    <div id="friends"></div>
  </div>

  <div id="main">
    <h2>Willkommen üëã</h2>
    <p>Online‚ÄëStatus & Freunde funktionieren</p>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
  authDomain: "enzae-4134d.firebaseapp.com",
  projectId: "enzae-4134d",
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let me;

function login(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

auth.onAuthStateChanged(async u=>{
  if(!u) return;
  me = u;
  document.getElementById("app").style.display="flex";

  const ref = db.collection("users").doc(u.uid);
  const snap = await ref.get();

  if(!snap.exists){
    let username = prompt("W√§hle einen Username (einmalig):");
    await db.collection("usernames").doc(username).set({uid:u.uid});
    await ref.set({
      uid:u.uid,
      name:u.displayName,
      username,
      online:true
    });
    await db.collection("friends").doc(u.uid).set({list:[]});
  }else{
    await ref.update({online:true});
  }

  document.getElementById("me").innerHTML =
    u.displayName + " <span class='online'>‚óè online</span>";

  loadFriends();
});

window.addEventListener("beforeunload",()=>{
  if(me) db.collection("users").doc(me.uid).update({online:false});
});

async function addFriend(){
  const name = addName.value;
  const doc = await db.collection("usernames").doc(name).get();
  if(!doc.exists) return alert("User nicht gefunden");

  const fid = doc.data().uid;
  if(fid===me.uid) return;

  const ref = db.collection("friends").doc(me.uid);
  await ref.update({
    list: firebase.firestore.FieldValue.arrayUnion(fid)
  });

  loadFriends();
}

async function loadFriends(){
  const box = document.getElementById("friends");
  box.innerHTML="";
  const snap = await db.collection("friends").doc(me.uid).get();
  for(const uid of snap.data().list){
    const u = await db.collection("users").doc(uid).get();
    const d = u.data();
    box.innerHTML+=`
      <div class="user">
        ${d.username}
        <span class="${d.online?'online':'offline'}">‚óè</span>
      </div>`;
  }
}
</script>
</body>
</html>
