<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>enzae</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#1e1f22;color:#dbdee1}
#login{height:100vh;display:flex;justify-content:center;align-items:center}
button{background:#5865f2;border:0;color:#fff;padding:8px 10px;border-radius:6px;cursor:pointer}
#app{display:none;height:100vh;display:flex}

.servers{width:70px;background:#1e1f22;padding:6px}
.server{background:#313338;margin-bottom:8px;padding:10px;text-align:center;border-radius:50%;cursor:pointer}
.server.active{background:#5865f2}

.channels{width:220px;background:#2b2d31;padding:10px}
.channel{padding:6px;border-radius:4px;cursor:pointer;color:#949ba4}
.channel.active,.channel:hover{background:#3f4147;color:#fff}

.chat{flex:1;display:flex;flex-direction:column}
.topbar{background:#2b2d31;padding:10px;font-weight:bold}
.messages{flex:1;padding:15px;overflow-y:auto}
.msg{display:flex;gap:10px;margin-bottom:12px}
.msg img{width:36px;height:36px;border-radius:50%}
.bubble{background:#313338;padding:8px 10px;border-radius:8px}

.inputbar{display:flex;gap:8px;padding:10px;background:#2b2d31}
input{flex:1;background:#1e1f22;border:0;border-radius:6px;color:#fff;padding:10px}
</style>
</head>

<body>

<div id="login">
  <button onclick="login()">Mit Google anmelden</button>
</div>

<div id="app">
  <div class="servers">
    <div class="server" onclick="createServer()">ï¼‹</div>
    <div id="serverList"></div>
  </div>

  <div class="channels">
    <h4 id="serverName">Server</h4>
    <div class="channel" onclick="createChannel()">ï¼‹ Channel</div>
    <div id="channelList"></div>
  </div>

  <div class="chat">
    <div class="topbar" id="channelName"># channel</div>
    <div class="messages" id="messages"></div>
    <div class="inputbar">
      <input id="msg" placeholder="Nachrichtâ€¦">
      <button onclick="send()">âž¤</button>
    </div>
  </div>
</div>

<script>
const loginDiv=document.getElementById("login");
const appDiv=document.getElementById("app");

firebase.initializeApp({
  apiKey:"AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
  authDomain:"enzae-4134d.firebaseapp.com",
  projectId:"enzae-4134d"
});

const auth=firebase.auth();
const db=firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let me=null;
let currentServer=null;
let currentChannel=null;

/* LOGIN */
function login(){
  const p=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(p);
}

auth.onAuthStateChanged(u=>{
  if(!u){loginDiv.style.display="flex";appDiv.style.display="none";return;}
  me=u;
  loginDiv.style.display="none";
  appDiv.style.display="flex";
  loadServers();
});

/* SERVERS */
function createServer(){
  const name=prompt("Server Name?");
  if(!name) return;
  db.collection("servers").add({
    name,
    owner:me.uid,
    members:[me.uid]
  });
}

function loadServers(){
  db.collection("servers")
    .where("members","array-contains",me.uid)
    .onSnapshot(s=>{
      serverList.innerHTML="";
      s.forEach(d=>{
        serverList.innerHTML+=`
          <div class="server" onclick="selectServer('${d.id}','${d.data().name}')">ðŸŸ£</div>`;
      });
    });
}

function selectServer(id,name){
  currentServer=id;
  serverName.textContent=name;
  loadChannels();
}

/* CHANNELS */
function createChannel(){
  if(!currentServer) return alert("Erst Server wÃ¤hlen");
  const name=prompt("Channel Name?");
  if(!name) return;
  db.collection("channels").add({
    server:currentServer,
    name
  });
}

function loadChannels(){
  db.collection("channels")
    .where("server","==",currentServer)
    .onSnapshot(s=>{
      channelList.innerHTML="";
      s.forEach(d=>{
        channelList.innerHTML+=`
          <div class="channel" onclick="selectChannel('${d.id}','${d.data().name}')">
            # ${d.data().name}
          </div>`;
      });
    });
}

function selectChannel(id,name){
  currentChannel=id;
  channelName.textContent="# "+name;
  loadMessages();
}

/* CHAT */
function send(){
  if(!msg.value||!currentChannel) return;
  db.collection("messages").add({
    channel:currentChannel,
    text:msg.value,
    name:me.displayName,
    photo:me.photoURL,
    time:Date.now()
  });
  msg.value="";
}

function loadMessages(){
  db.collection("messages")
    .where("channel","==",currentChannel)
    .onSnapshot(s=>{
      messages.innerHTML="";
      let arr=[];
      s.forEach(d=>arr.push(d.data()));
      arr.sort((a,b)=>a.time-b.time);
      arr.forEach(m=>{
        messages.innerHTML+=`
          <div class="msg">
            <img src="${m.photo}">
            <div class="bubble"><b>${m.name}</b><br>${m.text}</div>
          </div>`;
      });
      messages.scrollTop=messages.scrollHeight;
    });
}
</script>

</body>
</html>
