<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Enzae Chat</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <style>
    :root {
      --bg:#0f0f0f;--text:#e0e0e0;--msg-own:#1e88e5;--msg-other:#2d2d2d;
      --input:#1a1a1a;--border:#444;--accent:#2196f3;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
    #login,#usernameBox{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px}
    button{padding:16px 40px;font-size:18px;border-radius:14px;border:none;background:var(--accent);color:#fff}
    input{padding:16px;border-radius:14px;border:1px solid var(--border);background:var(--input);color:var(--text)}
    #app{display:none;height:100vh;flex-direction:column}
    header{padding:14px;background:#111;font-size:20px}
    #chat{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:6px}
    .msg{padding:10px 14px;border-radius:18px;max-width:80%}
    .own{background:#1e88e5;align-self:flex-end;color:white}
    .other{background:#2d2d2d;align-self:flex-start}
    .time{font-size:11px;opacity:.6}
    #sendBox{display:flex;padding:10px;gap:8px;border-top:1px solid #333}
    #msg{flex:1}
  </style>
</head>
<body>

<div id="login">
  <button onclick="loginWithGoogle()">Mit Google anmelden</button>
</div>

<div id="usernameBox" style="display:none">
  <h3>Username wÃ¤hlen</h3>
  <input id="usernameInput" placeholder="Username">
  <button onclick="saveUsername()">Speichern</button>
</div>

<div id="app">
  <header>Enzae Chat</header>
  <div id="chat"></div>
  <div id="sendBox">
    <input id="msg" placeholder="Nachricht...">
    <button onclick="sendMessage()">âž¤</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
  authDomain: "enzae-4134d.firebaseapp.com",
  projectId: "enzae-4134d",
  storageBucket: "enzae-4134d.firebasestorage.app",
  messagingSenderId: "96676313807",
  appId: "1:96676313807:web:57a7fdbe31c8cbe0ca55ba"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const loginDiv = document.getElementById("login");
const usernameDiv = document.getElementById("usernameBox");
const appDiv = document.getElementById("app");
const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("msg");

let user, username;

// LOGIN
function loginWithGoogle(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(()=>auth.signInWithRedirect(provider));
}
auth.getRedirectResult();

// AUTH STATE
auth.onAuthStateChanged(async u=>{
  if(!u){
    loginDiv.style.display="flex";
    return;
  }
  user=u;
  loginDiv.style.display="none";

  const doc = await db.collection("users").doc(user.uid).get();
  if(!doc.exists || !doc.data().username){
    usernameDiv.style.display="flex";
    return;
  }

  username=doc.data().username;
  usernameDiv.style.display="none";
  appDiv.style.display="flex";
  loadMessages();
});

// ðŸ”¥ FIX: KEIN reload mehr
async function saveUsername(){
  const name=document.getElementById("usernameInput").value.trim();
  if(name.length<2)return alert("Mind. 2 Zeichen");

  await db.collection("users").doc(user.uid).set({username:name},{merge:true});
  username=name;
  usernameDiv.style.display="none";
  appDiv.style.display="flex";
  loadMessages();
}

// SEND MESSAGE
async function sendMessage(){
  const text=msgInput.value.trim();
  if(!text)return;

  await db.collection("messages").add({
    text, user:username, uid:user.uid,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });
  msgInput.value="";
}

// LOAD
function loadMessages(){
  db.collection("messages").orderBy("time").onSnapshot(snap=>{
    chatDiv.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.uid===user.uid?"own":"other");
      div.innerHTML=`<b>${m.user}</b><br>${m.text}`;
      chatDiv.appendChild(div);
    });
    chatDiv.scrollTop=chatDiv.scrollHeight;
  });
}
</script>
</body>
</html>
