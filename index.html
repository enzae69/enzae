<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Enzae Chat mit Bildern</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
    body { margin:0; font-family:Arial; background:#111; color:#fff; }
    #login, #usernameBox { display:flex; justify-content:center; align-items:center; height:100vh; }
    #app { display:none; height:100vh; flex-direction:column; }
    #chat { padding:10px; flex:1; overflow-y:auto; }
    .msg { margin:8px 0; padding:8px; border-radius:8px; max-width:80%; }
    .msg.user-me   { background:#0066ff; align-self:flex-end; margin-left:auto; }
    .msg.user-other{ background:#333; }
    img.chat-img   { max-width:240px; border-radius:8px; margin-top:6px; display:block; }
    #sendBox { display:flex; gap:6px; padding:10px; background:#222; }
    input, button { padding:10px; }
    #file { display:none; }
    #preview { max-height:120px; margin:6px; display:none; }
  </style>
</head>
<body>

<div id="login">
  <button onclick="loginGoogle()">Mit Google anmelden</button>
</div>

<div id="usernameBox" style="display:none">
  <div>
    <h3>Username setzen</h3>
    <input id="usernameInput" placeholder="Dein Username">
    <button onclick="saveUsername()">Speichern</button>
  </div>
</div>

<div id="app">
  <h3 style="padding:10px; margin:0; background:#222">Enzae Chat</h3>
  <div id="chat"></div>
  <div id="sendBox">
    <input id="msg" placeholder="Nachricht ...">
    <label for="file" style="cursor:pointer; background:#444; padding:10px; border-radius:4px">ðŸ“Ž</label>
    <input type="file" id="file" accept="image/*">
    <img id="preview" alt="Vorschau">
    <button onclick="sendMessage()">Senden</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
  authDomain: "enzae-4134d.firebaseapp.com",
  projectId: "enzae-4134d",
  storageBucket: "enzae-4134d.firebasestorage.app",
  messagingSenderId: "96676313807",
  appId: "1:96676313807:web:57a7fdbe31c8cbe0ca55ba"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

let user, username, selectedFile = null;

const loginDiv     = document.getElementById("login");
const appDiv       = document.getElementById("app");
const usernameDiv  = document.getElementById("usernameBox");
const chatDiv      = document.getElementById("chat");
const msgInput     = document.getElementById("msg");
const fileInput    = document.getElementById("file");
const previewImg   = document.getElementById("preview");

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loginGoogle() {
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

auth.onAuthStateChanged(async u => {
  if (!u) {
    loginDiv.style.display = "flex";
    appDiv.style.display = "none";
    usernameDiv.style.display = "none";
    return;
  }

  user = u;
  loginDiv.style.display = "none";

  const doc = await db.collection("users").doc(u.uid).get();
  if (!doc.exists || !doc.data().username) {
    usernameDiv.style.display = "flex";
    appDiv.style.display = "none";
    return;
  }

  username = doc.data().username;
  usernameDiv.style.display = "none";
  appDiv.style.display = "flex";
  loadMessages();
});

async function saveUsername() {
  const name = document.getElementById("usernameInput").value.trim();
  if (!name) return alert("Bitte Username eingeben");
  await db.collection("users").doc(user.uid).set({ username: name }, { merge: true });
  location.reload();
}

// â”€â”€ Bild auswÃ¤hlen + Vorschau â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fileInput.addEventListener("change", e => {
  selectedFile = e.target.files[0];
  if (!selectedFile) return;

  const reader = new FileReader();
  reader.onload = ev => {
    previewImg.src = ev.target.result;
    previewImg.style.display = "block";
  };
  reader.readAsDataURL(selectedFile);
});

// â”€â”€ Nachricht / Bild senden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const text = msgInput.value.trim();

  if (!text && !selectedFile) return;

  let imageUrl = null;

  // 1. Bild hochladen (falls vorhanden)
  if (selectedFile) {
    try {
      const ext = selectedFile.name.split('.').pop();
      const path = `chat-images/${user.uid}/${Date.now()}.${ext}`;
      const ref = storage.ref().child(path);
      
      await ref.put(selectedFile);
      imageUrl = await ref.getDownloadURL();
    } catch (err) {
      console.error(err);
      alert("Bild-Upload fehlgeschlagen ðŸ˜¢");
      return;
    }
  }

  // 2. Nachricht in Firestore speichern
  try {
    await db.collection("messages").add({
      text: text || "",
      imageUrl: imageUrl || null,
      user: username,
      uid: user.uid,           // fÃ¼r spÃ¤tere "me"-Styling
      time: firebase.firestore.FieldValue.serverTimestamp()
    });

    msgInput.value = "";
    fileInput.value = "";
    selectedFile = null;
    previewImg.style.display = "none";
  } catch (err) {
    console.error(err);
    alert("Nachricht konnte nicht gesendet werden");
  }
}

// â”€â”€ Nachrichten live laden â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadMessages() {
  db.collection("messages")
    .orderBy("time")
    .onSnapshot(snap => {
      chatDiv.innerHTML = "";
      snap.forEach(doc => {
        const m = doc.data();
        const div = document.createElement("div");
        div.className = `msg ${m.uid === user?.uid ? "user-me" : "user-other"}`;

        let content = `<strong>${m.user}:</strong> ${m.text}`;
        if (m.imageUrl) {
          content += `<br><img class="chat-img" src="${m.imageUrl}" alt="Bild">`;
        }

        div.innerHTML = content;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
    });
}
</script>
</body>
</html>
