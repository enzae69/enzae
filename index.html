<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>enzae</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#313338;color:#fff}
button{background:#5865f2;border:0;color:#fff;padding:6px 10px;border-radius:5px;cursor:pointer}
input{padding:6px;border-radius:5px;border:0}
#login,#usernameBox{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
#app{display:none;height:100vh;display:flex}
#servers{width:70px;background:#1e1f22;padding:5px}
#channels{width:200px;background:#2b2d31;padding:10px}
#chat{flex:1;display:flex;flex-direction:column}
.server{background:#5865f2;margin-bottom:5px;text-align:center;padding:8px;border-radius:50%;cursor:pointer}
.channel{cursor:pointer;padding:5px}
.channel:hover{background:#3f4147}
#messages{flex:1;padding:10px;overflow-y:auto}
.msg{margin-bottom:8px}
#send{display:flex;padding:10px;background:#1e1f22}
.small{font-size:12px;color:#aaa}
</style>
</head>

<body>

<div id="login">
  <h2>enzae</h2>
  <button onclick="login()">Mit Google anmelden</button>
</div>

<div id="usernameBox" style="display:none">
  <h3>Username w√§hlen</h3>
  <input id="usernameInput" placeholder="username">
  <button onclick="saveUsername()">Speichern</button>
  <p id="userErr" class="small"></p>
</div>

<div id="app">

  <div id="servers">
    <div onclick="createServer()" class="server">+</div>
    <div id="serverList"></div>
  </div>

  <div id="channels">
    <b id="serverName">Server</b><br><br>
    <div id="channelList"></div>
    <button onclick="createChannel()">+ Channel</button>
    <hr>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="chat">
    <div style="padding:10px;background:#1e1f22" id="channelName"># channel</div>
    <div id="messages"></div>
    <div id="send">
      <input id="msgInput" style="flex:1" placeholder="Nachricht...">
      <button onclick="sendMessage()">Senden</button>
    </div>
  </div>

</div>

<script>
const firebaseConfig={
 apiKey:"AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
 authDomain:"enzae-4134d.firebaseapp.com",
 projectId:"enzae-4134d"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.firestore();

let user,currentServer,currentChannel,username;

auth.onAuthStateChanged(async u=>{
 if(!u){login.style.display="flex";app.style.display="none";return;}
 user=u; login.style.display="none";
 const doc=await db.collection("users").doc(u.uid).get();
 if(!doc.exists){usernameBox.style.display="flex";return;}
 username=doc.data().username;
 usernameBox.style.display="none";
 app.style.display="flex";
 loadServers();
});

function login(){
 auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function logout(){auth.signOut()}

async function saveUsername(){
 const n=usernameInput.value.trim();
 const q=await db.collection("users").where("username","==",n).get();
 if(!q.empty){userErr.innerText="Name vergeben";return;}
 await db.collection("users").doc(user.uid).set({username:n});
 location.reload();
}

/* SERVERS */
function createServer(){
 const name=prompt("Server Name");
 if(!name)return;
 db.collection("servers").add({name,owner:user.uid});
}

function loadServers(){
 db.collection("servers").onSnapshot(s=>{
  serverList.innerHTML="";
  s.forEach(d=>{
   const div=document.createElement("div");
   div.className="server";
   div.innerText=d.data().name[0];
   div.onclick=()=>selectServer(d.id,d.data().name);
   serverList.appendChild(div);
  });
 });
}

function selectServer(id,name){
 currentServer=id;
 serverName.innerText=name;
 loadChannels();
}

/* CHANNELS */
function createChannel(){
 const name=prompt("Channel Name");
 if(!name)return;
 db.collection("servers").doc(currentServer)
   .collection("channels").add({name});
}

function loadChannels(){
 db.collection("servers").doc(currentServer)
  .collection("channels")
  .onSnapshot(s=>{
   channelList.innerHTML="";
   s.forEach(d=>{
    const div=document.createElement("div");
    div.className="channel";
    div.innerText="# "+d.data().name;
    div.onclick=()=>selectChannel(d.id,d.data().name);
    channelList.appendChild(div);
   });
  });
}

function selectChannel(id,name){
 currentChannel=id;
 channelName.innerText="# "+name;
 loadMessages();
}

/* MESSAGES */
function sendMessage(){
 if(!msgInput.value)return;
 db.collection("servers").doc(currentServer)
  .collection("channels").doc(currentChannel)
  .collection("messages")
  .add({
   text:msgInput.value,
   user:username,
   time:firebase.firestore.FieldValue.serverTimestamp()
  });
 msgInput.value="";
}

function loadMessages(){
 db.collection("servers").doc(currentServer)
  .collection("channels").doc(currentChannel)
  .collection("messages")
  .orderBy("time")
  .onSnapshot(s=>{
   messages.innerHTML="";
   s.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="msg";
    div.innerHTML="<b>"+m.user+"</b>: "+m.text;
    messages.appendChild(div);
   });
   messages.scrollTop=messages.scrollHeight;
  });
}
</script>

</body>
</html>
