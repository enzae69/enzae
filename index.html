<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Enzae Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#fff}
#login,#usernameBox{display:flex;justify-content:center;align-items:center;height:100vh}
#app{display:none;height:100vh}
#chat{padding:10px;height:90vh;overflow-y:auto}
.msg{margin:6px 0}
input,button{padding:10px}
#sendBox{display:flex;gap:6px}
</style>
</head>

<body>

<div id="login">
  <button onclick="loginGoogle()">Mit Google anmelden</button>
</div>

<div id="usernameBox" style="display:none">
  <div>
    <h3>Username setzen</h3>
    <input id="usernameInput" placeholder="username">
    <button onclick="saveUsername()">Speichern</button>
  </div>
</div>

<div id="app">
  <h3 style="padding:10px">Enzae Chat</h3>
  <div id="chat"></div>
  <div id="sendBox">
    <input id="msg" placeholder="Nachricht">
    <button onclick="send()">Senden</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
  authDomain: "enzae-4134d.firebaseapp.com",
  projectId: "enzae-4134d",
  storageBucket: "enzae-4134d.firebasestorage.app",
  messagingSenderId: "96676313807",
  appId: "1:96676313807:web:57a7fdbe31c8cbe0ca55ba"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const login = document.getElementById("login");
const app = document.getElementById("app");
const usernameBox = document.getElementById("usernameBox");
const chat = document.getElementById("chat");

let user, username;

function loginGoogle(){
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

auth.onAuthStateChanged(async u=>{
  if(!u){
    login.style.display="flex";
    app.style.display="none";
    return;
  }

  user=u;
  login.style.display="none";

  const doc = await db.collection("users").doc(u.uid).get();
  if(!doc.exists || !doc.data().username){
    usernameBox.style.display="flex";
    app.style.display="none";
    return;
  }

  username = doc.data().username;
  usernameBox.style.display="none";
  app.style.display="block";
  loadMessages();
});

async function saveUsername(){
  const name = document.getElementById("usernameInput").value;
  if(!name) return;
  await db.collection("users").doc(user.uid).set({username:name});
  location.reload();
}

function send(){
  const text = document.getElementById("msg").value;
  if(!text) return;
  db.collection("messages").add({
    text,
    user: username,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById("msg").value="";
}

function loadMessages(){
  db.collection("messages")
    .orderBy("time")
    .onSnapshot(snap=>{
      chat.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="msg";
        div.textContent = m.user + ": " + m.text;
        chat.appendChild(div);
      });
      chat.scrollTop = chat.scrollHeight;
    });
}
</script>

</body>
</html>
