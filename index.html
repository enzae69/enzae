<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>enzae</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#313338;color:#fff}
button{background:#5865f2;border:0;color:#fff;padding:6px 10px;border-radius:5px;cursor:pointer}
input{padding:6px;border-radius:5px;border:0}
#login,#usernameBox{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center}
#app{display:none;height:100vh;display:flex}
#servers{width:60px;background:#1e1f22;padding:5px}
#left{width:240px;background:#2b2d31;padding:10px}
#chat{flex:1;display:flex;flex-direction:column}
#messages{flex:1;padding:10px;overflow-y:auto}
.msg{margin-bottom:8px}
.item{padding:6px;border-radius:4px;cursor:pointer}
.item:hover{background:#3f4147}
.small{font-size:12px;color:#aaa}
</style>
</head>

<body>

<div id="login">
  <h2>enzae</h2>
  <button onclick="login()">Mit Google anmelden</button>
</div>

<div id="usernameBox" style="display:none">
  <h3>Username wÃ¤hlen</h3>
  <input id="usernameInput" placeholder="username">
  <button onclick="saveUsername()">Speichern</button>
  <p id="userErr" class="small"></p>
</div>

<div id="app">

  <div id="servers">
    <div class="item" onclick="openGlobal()">#</div>
    <div class="item" onclick="openDMs()">ðŸ’¬</div>
  </div>

  <div id="left">
    <b id="leftTitle">Global</b>
    <div id="list"></div>

    <div id="friendsUI" style="display:none;margin-top:10px">
      <hr>
      <input id="friendInput" placeholder="Username adden">
      <button onclick="addFriend()">âž•</button>
    </div>

    <hr>
    <button onclick="logout()">Logout</button>
  </div>

  <div id="chat">
    <div style="padding:10px;background:#1e1f22" id="chatTitle">Chat</div>
    <div id="messages"></div>
    <div style="display:flex;padding:10px;background:#1e1f22">
      <input id="msgInput" style="flex:1" placeholder="Nachricht...">
      <button onclick="sendMessage()">Senden</button>
    </div>
  </div>

</div>

<script>
/* ðŸ”¥ CONFIG */
firebase.initializeApp({
 apiKey:"AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
 authDomain:"enzae-4134d.firebaseapp.com",
 projectId:"enzae-4134d"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* STATE */
let user = null;
let username = null;
let mode = "global";
let currentDM = null;

/* ðŸ” AUTH STATE â€“ LOOP FIX */
auth.onAuthStateChanged(async u=>{
  login.style.display = "none";
  app.style.display = "none";
  usernameBox.style.display = "none";

  if(!u){
    login.style.display = "flex";
    return;
  }

  user = u;

  let doc;
  try{
    doc = await db.collection("users").doc(u.uid).get();
  }catch(e){
    alert("Firestore Rules blockieren!");
    return;
  }

  if(!doc.exists || !doc.data().username){
    usernameBox.style.display = "flex";
    return;
  }

  username = doc.data().username;
  app.style.display = "flex";
  openGlobal();
});

/* AUTH */
function login(){
 auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}
function logout(){
 auth.signOut();
}

/* USERNAME */
async function saveUsername(){
 const n = usernameInput.value.trim();
 if(!n)return;

 const q = await db.collection("users").where("username","==",n).get();
 if(!q.empty){
  userErr.innerText = "Name vergeben";
  return;
 }

 await db.collection("users").doc(user.uid).set({
  username:n,
  createdAt:firebase.firestore.FieldValue.serverTimestamp()
 });

 location.reload();
}

/* GLOBAL CHAT */
function openGlobal(){
 mode="global";
 chatTitle.innerText="# global";
 leftTitle.innerText="Global";
 friendsUI.style.display="none";
 list.innerHTML="";
 loadGlobal();
}

function loadGlobal(){
 db.collection("messages")
 .orderBy("time")
 .onSnapshot(s=>{
  messages.innerHTML="";
  s.forEach(d=>{
   const m=d.data();
   messages.innerHTML+=`<div class="msg"><b>${m.user}</b>: ${m.text}</div>`;
  });
  messages.scrollTop=messages.scrollHeight;
 });
}

/* FRIENDS + DMS */
function openDMs(){
 mode="dm";
 leftTitle.innerText="Freunde";
 friendsUI.style.display="block";
 loadFriends();
}

async function addFriend(){
 const name = friendInput.value.trim();
 if(!name)return;

 const s = await db.collection("users").where("username","==",name).get();
 if(s.empty){ alert("Nicht gefunden"); return; }

 const fid = s.docs[0].id;
 await db.collection("friends").add({
  from:user.uid,
  to:fid,
  status:"accepted"
 });

 friendInput.value="";
 loadFriends();
}

function loadFriends(){
 list.innerHTML="";
 db.collection("friends")
 .where("from","==",user.uid)
 .where("status","==","accepted")
 .onSnapshot(s=>{
  list.innerHTML="";
  s.forEach(d=>{
   const div=document.createElement("div");
   div.className="item";
   div.innerText="ðŸ’¬ "+d.data().to;
   div.onclick=()=>openDM(d.data().to);
   list.appendChild(div);
  });
 });
}

function openDM(uid){
 currentDM = uid;
 chatTitle.innerText="DM";
 db.collection("dms")
 .doc(dmId(uid))
 .collection("messages")
 .orderBy("time")
 .onSnapshot(s=>{
  messages.innerHTML="";
  s.forEach(d=>{
   const m=d.data();
   messages.innerHTML+=`<div class="msg"><b>${m.user}</b>: ${m.text}</div>`;
  });
  messages.scrollTop=messages.scrollHeight;
 });
}

function dmId(other){
 return [user.uid,other].sort().join("_");
}

/* SEND */
function sendMessage(){
 if(!msgInput.value)return;

 if(mode==="global"){
  db.collection("messages").add({
   text:msgInput.value,
   user:username,
   time:firebase.firestore.FieldValue.serverTimestamp()
  });
 } else if(mode==="dm" && currentDM){
  db.collection("dms").doc(dmId(currentDM))
   .collection("messages").add({
    text:msgInput.value,
    user:username,
    time:firebase.firestore.FieldValue.serverTimestamp()
   });
 }

 msgInput.value="";
}
</script>
</body>
</html>
