<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enzae Chat</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#111;color:#eee}
#login,#usernameBox{height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:20px}
#app{display:none;height:100vh;flex-direction:column}
#chat{flex:1;overflow-y:auto;padding:10px}
.msg{padding:8px 12px;border-radius:12px;margin:6px 0;max-width:70%}
.own{background:#1e88e5;margin-left:auto}
.other{background:#333}
#sendBox{display:flex;padding:10px;border-top:1px solid #333;gap:6px}
input{flex:1;padding:10px;border-radius:10px;border:none}
button{padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
img{max-width:220px;border-radius:10px;margin-top:6px}
</style>
</head>

<body>

<div id="login">
  <button onclick="login()">Mit Google anmelden</button>
</div>

<div id="usernameBox" style="display:none">
  <input id="usernameInput" placeholder="Username">
  <button onclick="saveUsername()">Speichern</button>
</div>

<div id="app">
  <div id="chat"></div>
  <div id="sendBox">
    <input id="msg" placeholder="Nachricht...">
    <input type="file" id="file" accept="image/*">
    <button onclick="sendMessage()">âž¤</button>
  </div>
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyDfXuvBTQryCnIiNaMZ2goX5zsVc_tSZP4",
  authDomain: "enzae-4134d.firebaseapp.com",
  projectId: "enzae-4134d",
  storageBucket: "enzae-4134d.firebasestorage.app",
  messagingSenderId: "96676313807",
  appId: "1:96676313807:web:57a7fdbe31c8cbe0ca55ba"
});

const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const loginDiv = document.getElementById("login");
const userDiv = document.getElementById("usernameBox");
const appDiv = document.getElementById("app");
const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const fileInput = document.getElementById("file");

let user, username;

/* Login */
function login(){
  const p = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(p).catch(()=>auth.signInWithRedirect(p));
}

/* Auth State */
auth.onAuthStateChanged(async u=>{
  if(!u){
    loginDiv.style.display="flex";
    appDiv.style.display=userDiv.style.display="none";
    return;
  }
  user=u;
  loginDiv.style.display="none";

  const doc = await db.collection("users").doc(u.uid).get();
  if(!doc.exists || !doc.data().username){
    userDiv.style.display="flex";
    appDiv.style.display="none";
    return;
  }
  username = doc.data().username;
  userDiv.style.display="none";
  appDiv.style.display="flex";
  loadMessages();
});

/* Username speichern (KEIN Reload!) */
async function saveUsername(){
  const name = document.getElementById("usernameInput").value.trim();
  if(name.length<2) return alert("Mind. 2 Zeichen");

  await db.collection("users").doc(user.uid).set({username:name});
  username=name;
  userDiv.style.display="none";
  appDiv.style.display="flex";
  loadMessages();
}

/* Senden */
async function sendMessage(){
  if(!auth.currentUser) return;

  let imageUrl=null;
  const file=fileInput.files[0];

  if(file){
    const ref=storage.ref(`chat/${user.uid}/${Date.now()}`);
    await ref.put(file);
    imageUrl=await ref.getDownloadURL();
  }

  await db.collection("messages").add({
    text: msgInput.value,
    imageUrl,
    uid: user.uid,
    user: username,
    time: firebase.firestore.FieldValue.serverTimestamp()
  });

  msgInput.value="";
  fileInput.value="";
}

/* Laden */
function loadMessages(){
  db.collection("messages").orderBy("time")
    .onSnapshot(s=>{
      chatDiv.innerHTML="";
      s.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="msg "+(m.uid===user.uid?"own":"other");
        div.innerHTML=`<b>${m.user}</b><br>${m.text||""}`;
        if(m.imageUrl) div.innerHTML+=`<br><img src="${m.imageUrl}">`;
        chatDiv.appendChild(div);
      });
      chatDiv.scrollTop=chatDiv.scrollHeight;
    });
}
</script>

</body>
</html>
