<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ENZAE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ðŸ”¥ DEIN Firebase CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyDFXuVBTQryCnIiNaMZ2goX5zsVc_tSZP4",
      authDomain: "enzae-4134d.firebaseapp.com",
      projectId: "enzae-4134d",
      storageBucket: "enzae-4134d.appspot.com",
      messagingSenderId: "96676313807",
      appId: "1:96676313807:web:57a7fdbe31c8cbe0ca55ba"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const chat = document.getElementById("chat");
    const messagesDiv = document.getElementById("messages");
    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const usernameSpan = document.getElementById("username");

    let currentUser = null;

    // âœ… LOGIN
    loginBtn.onclick = async () => {
      await signInWithPopup(auth, provider);
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    // âœ… AUTH STATE (KEINE LOOP!)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        usernameSpan.textContent = user.displayName;
        document.getElementById("auth").style.display = "none";
        chat.style.display = "flex";
        startChat();
      } else {
        document.getElementById("auth").style.display = "flex";
        chat.style.display = "none";
      }
    });

    // ðŸ’¬ CHAT
    function startChat() {
      const q = query(
        collection(db, "messages"),
        orderBy("createdAt")
      );

      onSnapshot(q, (snapshot) => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const m = doc.data();
          const div = document.createElement("div");
          div.className = "message";

          div.innerHTML = `
            <img src="${m.photo}" />
            <div class="bubble">
              <strong>${m.name}</strong><br/>
              ${m.text}
            </div>
          `;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
    }

    // âœï¸ SEND MESSAGE
    form.onsubmit = async (e) => {
      e.preventDefault();
      if (!input.value.trim()) return;

      await addDoc(collection(db, "messages"), {
        text: input.value,
        name: currentUser.displayName,
        photo: currentUser.photoURL,
        createdAt: serverTimestamp()
      });

      input.value = "";
    };
  </script>

  <!-- STYLE -->
  <style>
    body {
      margin: 0;
      background: #1e1f22;
      font-family: Arial, sans-serif;
      color: white;
    }

    #auth {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button {
      background: #5865f2;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-size: 16px;
    }

    #chat {
      display: none;
      height: 100vh;
      flex-direction: column;
    }

    header {
      background: #2b2d31;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .message {
      display: flex;
      margin-bottom: 10px;
      gap: 10px;
    }

    .message img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .bubble {
      background: #313338;
      padding: 10px;
      border-radius: 8px;
      max-width: 70%;
    }

    form {
      display: flex;
      padding: 10px;
      background: #2b2d31;
    }

    input {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: none;
      outline: none;
      background: #1e1f22;
      color: white;
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="auth">
    <button id="loginBtn">Mit Google anmelden</button>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <header>
      <div>ðŸŸ£ ENZAE â€” <span id="username"></span></div>
      <button id="logoutBtn">Logout</button>
    </header>

    <div id="messages"></div>

    <form id="form">
      <input id="input" placeholder="Nachricht schreiben..." autocomplete="off"/>
    </form>
  </div>

</body>
</html>
